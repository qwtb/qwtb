\documentclass[12pt,a4paper,oneside]{report} %<<<1 ------------------------------
% fonts, encoding:
\usepackage[utf8]{inputenc}             % file is in utf8:
\usepackage{cmap}                       % pdf is created with correct special characters, requires proper font, see next two lines
\usepackage[T1]{fontenc}                % see higher line
\usepackage{tgtermes}                   % high quality times font
\usepackage{textcomp}                   % proper micro sign for SI, use: \textmu, in equation: $\hbox{\textmu}$
\usepackage{slantsc}                   % proper micro sign for SI, use: \textmu, in equation: $\hbox{\textmu}$
\usepackage{calc}                   % provides \widthof
\usepackage{enumitem}                   % provides \begin{description} with settings []
\usepackage{color}                   % provides coloured text
% obrazky:
\usepackage{graphicx}                   % to insert pictures
\usepackage{grffile}                    % enables spaces in picture file names
\grffilesetup{ multidot=false, babel=false, encoding, inputencoding=utf8, filenameencoding=utf8, space=true}
\newcommand*{\FILEDOT}{.}                   % if picture file name containt dot (e.g. aaa.bbb.pdf), then TeX considers rest as filename extension, so dot must be written as follows: \includegraphics{aaa\FILEDOT bbb.eps}
% rest:
\usepackage[pdftex,
            unicode,
            pdfauthor={Q-Wave consorcium},
            pdftitle={QWTB documentation},
            pdfkeywords={algorithm, data procesing, sampling, toolbox},
            pdfproducer={Latex with hyperref},
            pdfcreator={pdflatex}]{hyperref}
%\usepackage[a4paper]{geometry}          % ensure A4
%\geometry{verbose,lmargin=2.5cm,rmargin=2.5cm,tmargin=2.5cm,bmargin=2.5cm}      % margins settings
\usepackage{url}                        % enables \url in bibtex
%\usepackage{setspace} \doublespacing   % double line spacing, for 1.5 set \onehalfspace
\usepackage{xspace}                     % proper automatic spacing after user defined commands
\usepackage{amsmath}                    % better equations

% lstlisting settings %<<<1 ----------------------------------------------------
\usepackage{listings}                   % for source code formatting
\input{code_highlight_settings.tex}     % user defined code formatting

% bibliography settings %<<<1 ----------------------------------------------------
\usepackage[english]{babel} % main language of the document must be last
\usepackage[
   backend=biber      % if we want unicode 
  ,style=ieee   % or iso-numeric for numeric citation method          
  ,babel=other        % to support multiple languages in bibliography
  %,sortlocale=cs_CZ   % locale of main language, it is for sorting
  ,sortlocale=en_UK   % locale of main language, it is for sorting
  ,bibencoding=UTF8   % this is necessary only if bibliography file is in different encoding than main document
]{biblatex}

\bibliography{lib}
%\defbibenvironment{bibliography}
%    {\list
%        {[\printfield[labelnumberwidth]{labelnumber}]}
%        {\setlength{\labelwidth}{\labelnumberwidth}
%        \setlength{\leftmargin}{4pt}
%        \setlength{\labelsep}{10pt}
%        \addtolength{\leftmargin}{\labelsep}
%        \setlength{\itemsep}{6pt}
%        \setlength{\parsep}{\bibparsep}}
%        \renewcommand*{\makelabel}[1]{\hss##1}}
%    {\endlist}
%    {\item}

% shorts: %<<<1 ----------------------------------------------------

\def\Alg{{\sc Algorithm}\xspace}
\def\Algs{{\sc Algorithms}\xspace}
\def\Tb{{\sc Toolbox}\xspace}
\def\Da{{\sc Data}\xspace}
\def\Mea{{\sc Measurement}\xspace}
\def\Qua{{\sc Quantity}\xspace}
\def\Quas{{\sc Quantities}\xspace}
\def\Wr{{\sc Wrapper}\xspace}
\def\Wrs{{\sc Wrappers}\xspace}
\def\matlab{{\sc MATLAB}\xspace}
\def\octave{{\sc GNU Octave}\xspace}
\def\labview{{\sc LabVIEW}\xspace}
\def\mgo{\matlab/\octave\xspace}
        
\begin{document} % other document settings --------------------------------------------%<<<1
% how to devide special words, e.g. auto-mation
\hyphenation{Frame-work OpenOffice SourceForge Windows}
%\def\thesection{\Roman{section}}       % redefines numbering style of sections
\renewcommand\floatpagefraction{.9} \renewcommand\topfraction{.9} \renewcommand\bottomfraction{.9} \renewcommand\textfraction{.1} \setcounter{totalnumber}{50} \setcounter{topnumber}{50} \setcounter{bottomnumber}{50} % if too many pictures, change text/float fraction
\renewcommand{\labelitemi}{--}          % item sepparator
\setlength{\unitlength}{1mm}            % default length in picture environment

% tight description environment:
\newenvironment{tightdesc}{\begin{description}[itemsep=0pt]} 
                              {\end{description}}

% names of sections:
\def\infosection{Description}
\def\examplesection{Example}
% remove "chapter" from chapter heading:
\renewcommand{\chaptername}{}

\title{QWTB: Toolbox description}
\author{Q-Wave consorcium}

% first page ----------------------------------------------------------------------- %<<<1 ------------------------------
\thispagestyle{empty}
\begin{center}
        \vspace*{10em}
        {\huge
        \includegraphics[width=0.3\textwidth]{logo/qwtb_logo.pdf}

        \vspace{2.0em}
        QWTB documentation\\

        \vspace{1.5em}
        Toolbox description}\\

        \vfill
        {\Large \color{red}{QWTB version 0.2}}

        \vspace{1em}
        {\Large \url{https://qwtb.github.io/qwtb/}}
\end{center}
\newpage

\tableofcontents

\chapter{Introduction} %<<<1 ------------------------------
\bigskip
\begin{center}
        \parbox{0.7\textwidth}{\textit{Press a button with bold title AMPLITUDE\\
        \dots drink a coffee \dots\\
        and get the result}}
\end{center}

\bigskip
\noindent QWTB is a toolbox for evaluation of measured data. QWTB consist of data
processing algorithms from very different sources and unificating application interface. The toolbox
gives the possibility to use different data processing algorithms with one set of data and removes
the need to reformat data for every particular algorithm. Toolbox is extensible. The toolbox
can variate input data and calculate uncertainties by means of Monte Carlo Method
(MCM)~\cite{JCGM2008}.

Toolbox was realized within the EMRP-Project SIB59 Q-Wave. The EMRP is jointly funded by the EMRP
par- ticipating countries within EURAMET and the European Union.

\vfill
\includegraphics[width=0.3\textwidth]{sources/Q-Wave_logo_01.pdf}
\hfill
\includegraphics[width=0.3\textwidth]{sources/eurametlogo.jpg}


\chapter{Installation} %<<<1 ----------------------------------------
\section{QWTB} %<<<2 ----------------------------------------
The toolbox can be downloaded either as a~{\sc git} repository or as a zip archive containing
documentation and a {\tt qwtb} directory containing all scripts and algorithms. Extract
archive into a directory of your selection {\tt YourDirectory}.

Start \matlab or \octave. To use the toolbox, two methods can be used:
\begin{enumerate}
        \item Change current working directory of \matlab or \octave by command:
\end{enumerate}

\begin{lstlisting}
cd('YourDirectory/qwtb')
\end{lstlisting}

\begin{enumerate}
        \setcounter{enumi}{1}
        \item Or add toolbox directory into the search path by command:
\end{enumerate}
\begin{lstlisting}
addpath('YourDirectory/qwtb')
\end{lstlisting}

\section{QWTBLVLib} %<<<2 ----------------------------------------
Library can be downloaded either as source codes in a~{\sc git} repository or as a zip archive
containing packed project library with {\tt .lvlibp} and {\tt .dll} libraries. Extract archive into
a directory of your selection and import into your \labview project. 

\section{simple QWTB GUI} %<<<2 ----------------------------------------
Simple graphical user interace can be downloaded either as source codes in a~{\sc git} repository or
as a zip archive containing executable and required libraries. Extract archive into a directory of
your selection and run the executable file.

\chapter{Basic description of the toolbox} %<<<1 ------------------------
\section{Toolbox overall scheme} %<<<2 ------------------------------
The basic scheme of the toolbox is following:
\begin{center}
        \includegraphics{sources/basic scheme v2.pdf}
\end{center}

User have to prepare the data, either based on a real measurement or simulated, into a specified
format. If needed, user can generate randomized data for selected quantities (e.g. with special
probability density functions) and prepare for Monte Carlo uncertainty calculation. Next user calls
toolbox to apply a selected algorithm on the data and review results. Toolbox will:
\begin{enumerate}
        \item Check user data.
        \item Check or generate calculation settings.
        \item If required, quantities are randomized according uncertainties to prepare for MCM uncertainty calculation.
        \item Data are handled to a wrapper. If needed, wrapper is run multiple times according to MCM.
        \item Output data are the result of the toolbox.
\end{enumerate}

Another algorithm can be used immediately on the same data. User interface of the toolbox is represented
by the function \lstinline{qwtb} defined in the file {\tt qwtb.m}.

\section{Toolbox use} %<<<2 ------------------------------
The toolbox is used in several modes according to a number and character of input arguments.

\subsection{Get informations of all implemented algorithms} %<<<3
\begin{lstlisting}
alginfo = qwtb()
\end{lstlisting}

With no input arguments, toolbox returns informations of all available algorithms. Result array
\lstinline{alginfo} contains structures for every algorithm found in the same directory as
\texttt{qwtb.m}. Format of structures is defined in~\ref{structalginfo}.

This call can be also used to get \emph{standard} calculation settings used in the toolbox:
\begin{lstlisting}
[alginfo, calcset] = qwtb()
\end{lstlisting}
For use of calcset, see next chapter.

\subsection{Application of an algorithm on the data} %<<<3 ------------------------------
\begin{lstlisting}
dataout = qwtb('algid', datain)
\end{lstlisting}

The algorithm is selected by first input argument \lstinline{algid}. It is a string with
designator of the algorithm, according structrue~\ref{structalginfo}.

The second input argument is the user data. Data have to be formatted in a structure with fields
named as quantities required by the algorithm (see~\ref{structquantity}).

The output variable is the structure with fields named as quantities.

In this case, standard calculation settings are used. If the user specifies calculation settings
in structure according~\ref{structcalcset}, it can be used as third input argument
\lstinline{calcset}:

\begin{lstlisting}
dataout = qwtb('algid', datain, calcset)
\end{lstlisting}

For some calculation settings some fields of \lstinline{datain} or \lstinline{calcset} are generated
automatically. To review automatically generated fields, user can get these structure in second and
third output argument:

\begin{lstlisting}
[dataout, datain, calcset] = qwtb('algid', datain)
[dataout, datain, calcset] = qwtb('algid', datain, calcset)
\end{lstlisting}

\subsection{Running an example of algorithm use} %<<<3 ------------------------------
Algorithm can have implemented an example of the use. This can be run by following syntax:

\begin{lstlisting}
qwtb('algid', 'example')
\end{lstlisting}

The algorithm is selected by first input argument \lstinline{algid}. It is a string with
designator of the algorithm, according structrue~\ref{structalginfo}. The second argument is a
string. Toolbox will run a script \lstinline{alg_example.m} located in a algorithm directory.

After finish user can review input and output data or resulted figures if any.

\subsection{Running a test of algorithm} %<<<3 ------------------------------
Algorithm can have implemented a self test. This can be run by following syntax:

\begin{lstlisting}
qwtb('algid', 'test')
\end{lstlisting}

The algorithm is selected by first input argument \lstinline{algid}. It is a string with
designator of the algorithm, according structrue~\ref{structalginfo}. The second argument is a
string. Toolbox will run a script \lstinline{alg_test.m} located in a algorithm directory.

Test should prepare data, run algorithm and check results. If implementation of algorithm
behaves incorrectly, an error will occur.

\subsection{Get informations of algorithm} %<<<3 ------------------------------
To get informations of only the selected algorithm, following syntax is used:
\begin{lstlisting}
qwtb('algid', 'info')
\end{lstlisting}

Result structure is defined in~\ref{structalginfo}.

\subsection{Adding or removing algorithm path} %<<<3 ------------------------------
Algorithms are stored in different directories, which are not in \mgo load path. To add directory
with selected path to \mgo load path, following syntax is used:

\begin{lstlisting}
qwtb('algid', 'addpath')
\end{lstlisting}

To remove path, use:

\begin{lstlisting}
qwtb('algid', 'rempath')
\end{lstlisting}

Adding or removing path should be required only in special cases, such as debugging etc.

\subsection{Displaying license of an algorithm} %<<<3 ------------------------------------
To display a license of an algorithm, following syntax is used:
\begin{lstlisting}
license = qwtb('algid', 'license')
\end{lstlisting}
For details on licensing, see chapter~\ref{ch-license}.


\chapter{Detailed description of the toolbox} %<<<1 ------------------------------
\section{Algorithm directory structure implementation} %<<<2 ------------------------------
\label{diralg}
Every algorithm is placed in a directory of following name:
\begin{center}
        {\tt alg\_X}
\end{center}
These directories have to be located in the directory containing the toolbox main script {\tt qwtb.m}.

Every algorithm directory contains following files:
\begin{tightdesc}
        \item [{\tt X1}, {\tt X2}, \dots] ---  Mandatory. One or more files with the algorithm itself.
        \item [{\tt alg\_info.m}] ---  Mandatory. Description of the algorithm. See \ref{filealginfo}.
        \item [{\tt alg\_wrapper.m}] ---  Mandatory. Wrapper of the algorithm. See \ref{filealgwrapper}.
        \item [{\tt alg\_test.m}] ---  Recomended. Testing function. See \ref{filealgtest}.
        \item [{\tt alg\_example.m}] ---  Recomended. Example script. See \ref{filealgexample}.
\end{tightdesc}

\subsection{File {\tt alg\_info.m}} %<<<3 ------------------------------
\label{filealginfo}
File contains a function with definition:

\begin{lstlisting}
function alginfo = alg_info()
\end{lstlisting}

The output \lstinline{alginfo} is a structure with informations about the algorithm. Structure is
defined in~\ref{structalginfo}.

File is mandatory. If file is missing in algorithm directory, QWTB will not recognize this
algorithm as part of the toolbox.

\subsection{File {\tt alg\_wrapper.m}} %<<<3 ------------------------------
\label{filealgwrapper}
File contains a function with definition:

\begin{lstlisting}
function dataout = alg_wrapper(datain, calcset)
\end{lstlisting}

The input \lstinline{datain} is a structure with input data (see %XXX
), \lstinline{calcset} is a structure with definition of calculation settings
(see~\ref{structcalcset}).
) and \lstinline{dataout} is a structure containing output data (see %XXX
).

The wrapper does following:
\begin{enumerate}
        \item Formats input data structure \lstinline{datain} into variables wuitable for algorithm.
        \item Runs the algorithm.
        \item Format results of the algorithm into data structure \lstinline{dataout}.
\end{enumerate}

File is mandatory. If file is missing in algorithm directory, QWTB will not recognize this
algorithm as part of the toolbox.

\subsection{File {\tt alg\_test.m}} %<<<3 ------------------------------
\label{filealgtest}
File contains a function with following definition:

\begin{lstlisting}
function alg_test(calcset)
\end{lstlisting}

Test should generate sample data, run algorithm and check results by a function \lstinline{assert}.
QWTB will provide a standard calculation settings structure \lstinline{calcset}
(see~\ref{structcalcset}), which is used as a function input variable.

This file is not mandatory, however is recommended.

\subsection{File {\tt alg\_example.m}} %<<<3 ------------------------------
\label{filealgexample}

Example contains a script showing a basic use of the algorithm. The format of the file should
conform to the publishing markup defined in Matlab documentation. See matlab help on keyword
\emph{Publishing markup}). The QWTB runs this script in base context, thus all variables defined in
the example script will be accessible to the user.

To create a documentation of the QWTB, function \lstinline{publish} is applied to the example script
and resulting file is attached to the documentation file.

\subsection{Overall flow chart} %<<<3 ----------------------------------------
The main toolbox file {\tt qwtb.m} calls files in algorithm directory according following flow
chart:
\begin{center}
        \includegraphics[width=1.0\textwidth]{sources/outer_flowchart.pdf}
\end{center}
Red arrow marks recursion, blue box represents files of the algorithm itself, green boxes represents
files required or recommended by the toolbox.

\section{Algorithm informations structure} %<<<2 ------------------------------
\label{structalginfo}
Structure defines properties and possibilities of the algorithm. All fields are mandatory but
\lstinline{.fullpath}.

\begin{tightdesc}
        \item [\textsf{.id}] --- Designator of the algorithm.
        \item [\textsf{.name}] ---  Name of the algorithm.
        \item [\textsf{.desc}] ---  Basic description.
        \item [\textsf{.citation}] ---  Reference.
        \item [\textsf{.remarks}] ---  Any remark.
        \item [\textsf{.license}] ---  License of the algorithm.
        \item [\textsf{.inputs}] ---  Input quantities definitions.
        \item [\textsf{.outputs}] ---  Output quantities definitions.
        \item [\textsf{.providesGUF}] ---  Algorithm/wrapper calculates GUF uncertainty.
        \item [\textsf{.providesMCM}] ---  Algorithm/wrapper calculates MCM uncertainty.
        \item [\textsf{.fullpath}] ---  Full path to the algorithm. Automatically generated by the toolbox.
\end{tightdesc}

\subsection{\textsf{.id}} %<<<3 ------------------------------
\label{structalginfoid}
String. Designator of the algorithm. It is unique identifier, no two algorithms can have same id.

\subsection{\textsf{.name}} %<<<3 ------------------------------
\label{structalginfoname}
String. Full name of the algorithm. 

\subsection{\textsf{.desc}} %<<<3 ------------------------------
\label{structalginfodesc}
String. Basic description of the algorithm.

\subsection{\textsf{.citation}} %<<<3 ------------------------------
\label{structalginfocitation}
String. A reference to the paper, book or other literature with full description of the algorithm.

\subsection{\textsf{.remarks}} %<<<3 ------------------------------
\label{structalginforemarks}
String. Remarks or others related to the algorithm.

\subsection{\textsf{.license}} %<<<3 ------------------------------
\label{structalginfolicense}
String. License of the algorithm. This is not license of the toolbox but of the algorithm!

\subsection{\textsf{.inputs}} %<<<3 ------------------------------
\label{structalginfoinputs}
Array of structures. Every structure define an input quantity. Structure has following mandatory
fields:
\begin{tightdesc}
        \item [\textsf{.name}] --- Name of input quantity.
        \item [\textsf{.desc}] --- Description of input quantity.
        \item [\textsf{.alternative}] --- Index of group of alternative quantities.
        \item [\textsf{.optional}] --- Sets quantity to be optional.
        \item [\textsf{.parameter}] --- Sets quantity to be a parameter.
\end{tightdesc}

\subsubsection{\textsf{.name}} %<<<4 ------------------------------
String. Name of input quantity.

\subsubsection{\textsf{.desc}} %<<<4 ------------------------------
String. Short description of input quantity.

\subsubsection{\textsf{.alternative}} %<<<4 ------------------------------
Integer. Index of group of alternative quantities. If several input quantities has the same index,
QWTB requires only one of quantities in the group. If set to zero, quantity is not part of any group.

For example, suppose a sampling time \lstinline{Ts} and sampling frequency \lstinline{fs} has the same
index. The algorithm requires \lstinline{fs}, but the wrapper can calculate \lstinline{fs} 
from \lstinline{Ts}. User can supply only \lstinline{fs} to run the algorithm. But he can also supply
only the \lstinline{Ts} and the wrapper calculates \lstinline{fs} from \lstinline{Ts} and runs the algorithm. The
wrapper should always notice the user that some quantity was calculated from other one. If user
supplies both, the wrapper should choose the quantity most suitable for the algorithm.

\subsubsection{\textsf{.optional}} %<<<4 ------------------------------
Boolean. If set, the quantity is optional. The QWTB do not require user to supply this quantity. If
quantities are part of a group of alternative quantities, the group itself is considered optional
only if all quantities are optional.

\subsubsection{\textsf{.parameter}} %<<<4 ------------------------------
Boolean. If set, the quantity is considered as optional. This means the quantity do not have to be a
number and is not randomized by QWTB.
% XXX is parameter always optional or not? I think this is not finished in qwtb.m

\subsection{\textsf{.outputs}} %<<<3 ------------------------------
\label{structalginfooutputs}
Array of structures. Every structure define an output quantity. Structure has following mandatory
fields:
\begin{tightdesc}
        \item [\textsf{.name}] --- Name of output quantity.
        \item [\textsf{.desc}] --- Description of output quantity.
\end{tightdesc}

\subsubsection{\textsf{.name}} %<<<4 ------------------------------
String. Name of output quantity.

\subsubsection{\textsf{.desc}} %<<<4 ------------------------------
String. Short description of output quantity.

\subsection{\textsf{.providesGUF}} %<<<3 ------------------------------
\label{structalginfoprovidesGUF}
Boolean. If nonzero, the wrapper or the algorithm calculates uncertainty by means of GUM Uncertainty
Framework.

\subsection{\textsf{.providesMCM}} %<<<3 ------------------------------
\label{structalginfoprovidesMCM}
Boolean. If nonzero, the wrapper or the algorithm calculates uncertainty by means of Monte Carlo
Method.

\subsection{\textsf{.fullpath}} %<<<3 ------------------------------
\label{structalginfofullpath}
String. Full path to the algorithm. This field is automatically generated by QWTB and should not be
part of {\tt alg\_test.m}.

\section{Quantity structure} %<<<2 ------------------------------
\label{structquantity}
Every quantity is a structure with following fields:
\begin{tightdesc}
        \item [\textsf{.v}] --- Value.
        \item [\textsf{.u}] --- Uncertainty.
        \item [\textsf{.d}] --- Degree of freedom.
        \item [\textsf{.c}] --- Correlation.
        \item [\textsf{.r}] --- Randomized uncertainty.
\end{tightdesc}

\subsection{\textsf{.v}} %<<<3 ------------------------------
\label{structquantityv}
Value of the quantity. Can be a scalar, vector or matrix. More dimensions are not
supported. 

Vectors should be ordered in a single \emph{row}. If the vector is ordered in a collumn,
it is automatically transposed and a warning is generated. Other fields (\textsf{.u},
\textsf{.d}, \textsf{.r}) are transposed if needed to match the value of the quantity.

\subsection{\textsf{.u}} %<<<3 ------------------------------
\label{structquantityu}
Standard uncertainty of the quantity. Dimensions are the same as of the value field.

\subsection{\textsf{.d}} %<<<3 ------------------------------
\label{structquantityd}
Degrees of freedom the uncertainty according GUM Uncertainty Framework. Dimensions are the same as of the value field.

This field is automatically generated by the toolbox if missing, required and \lstinline{calcset.dof.gen}
is set to nonzero. The value will be set to 50.

\subsection{\textsf{.c}} %<<<3 ------------------------------
\label{structquantityc}
Correlation matrix for quantity. 2DO XXX.

This field can be automatically generated by the toolbox if missing, required and \lstinline{calcset.cor.gen}
is set to nonzero. The value will be set to 0.

\subsection{\textsf{.r}} %<<<3 ------------------------------
\label{structquantityr}
Randomized uncertainties according Monte Carlo method. In the case of scalar quantity it is
\emph{column} vector of length equal to \lstinline{calcset.mcm.repeats}. For a vector quantity it is a matrix with number
of columns equal to length of value of the quantity and number of rows equal to
\lstinline{calcset.mcm.repeats}. For a matrix quantity it is a matrix with three dimensions, first
two equal to the dimensions of value quantity, third dimension equal to
\lstinline{calcset.mcm.repeats}.

This field is required if Monte Carlo uncertainty calculation is required. In this case it can be
automatically generated by the toolbox if missing and \lstinline{calcset.mcm.randomize} is set to
boolean. The pdf will be normal, sigma will be equal to the standard uncertainty of the quantity.

\subsection{Quantity structure examples} %<<<3 ------------------------------
Example of scalar quantity of mean value 1, standard uncertainty 0.1, degrees of freedom 9, correlation has no
sense for scalar quantity, and radnomized matrix has number of elements equal to \lstinline{calcset.mcm.randomize}.
\begin{eqnarray*}
        \text{\textsf{.v}:} &(1)\\
        \text{\textsf{.u}:} &(0.1)\\
        \text{\textsf{.d}:} &(9)\\
        \text{\textsf{.c}:} &(0)\\
        \text{\textsf{.r}:} &\begin{pmatrix}
                1.02076 \\
                1.22555 \\
                \vdots\\
                0.89727 \\
        \end{pmatrix}\\
\end{eqnarray*}

Example of vector quantity with $i$ elements, $M$ is equal to \lstinline{calcset.mcm.randomize} (only symbolic representation):
\begin{eqnarray*}
        \text{\textsf{.v}:} & (v_1, v_2, \dots, v_i) \\
        \text{\textsf{.u}:} & (u_1, u_2, \dots, u_i) \\
        \text{\textsf{.d}:} & (d_1, d_2, \dots, d_i) \\
        \text{\textsf{.c}:} & \left(    \begin{array}{ccc}
                                                c_{11}  & \hdots & c_{1i} \\
                                                \vdots  & \ddots & \vdots \\
                                                c_{i1}  & \hdots & c_{ii} \\
                                        \end{array}\right) \\
        \text{\textsf{.r}:} & \left(    \begin{array}{ccc}
                                                r_{11}  & \hdots & r_{1i} \\
                                                \vdots  & \ddots & \vdots \\
                                                r_{M1}  & \hdots & r_{Mi} \\
                                        \end{array}\right) \\
\end{eqnarray*}

Example of matrix quantity with $i$ times $j$ elements, $M$ is equal to \lstinline{calcset.mcm.randomize} (only symbolic representation):
\begin{eqnarray*}
        \text{\textsf{.v}:} & \left(    \begin{array}{ccc}
                                                v_{11}  & \hdots & v_{1j} \\
                                                \vdots  & \ddots & \vdots \\
                                                v_{i1}  & \hdots & v_{ij} \\
                                        \end{array}\right) \\
        \text{\textsf{.u}:} & \left(    \begin{array}{ccc}
                                                v_{11}  & \hdots & u_{1j} \\
                                                \vdots  & \ddots & \vdots \\
                                                u_{i1}  & \hdots & u_{ij} \\
                                        \end{array}\right) \\
        \text{\textsf{.d}:} & \left(    \begin{array}{ccc}
                                                d_{11}  & \hdots & d_{1j} \\
                                                \vdots  & \ddots & \vdots \\
                                                d_{i1}  & \hdots & d_{ij} \\
                                        \end{array}\right) \\
        \text{\textsf{.c}:} & \left(    XXX??? \right) \\
        \text{\textsf{.r}:} & \left(    \begin{array}{ccc}
                                                r_{111}  & \hdots & r_{1j1} \\
                                                \vdots  & \ddots & \vdots \\
                                                r_{i11}  & \hdots & r_{ij1} \\
                                        \end{array}\right) \\
                            & \qquad\vdots                        \\
                            & \left(    \begin{array}{ccc}
                                                r_{11M}  & \hdots & r_{1jM} \\
                                                \vdots  & \ddots & \vdots \\
                                                r_{i1M}  & \hdots & r_{ijM} \\
                                        \end{array}\right) \\
\end{eqnarray*}

\section{Calculation settings structure} %<<<2 ------------------------------
\label{structcalcset}
Structure defines calculation methods.
\begin{tightdesc}
        \item [\textsf{.strict}] ---  (0) If zero, other fields generated automatically.
        \item [\textsf{.verbose}] ---  (1) Display various informations.
        \item [\textsf{.checkinputs}] ---  (0) Check if inputs are proper.
        \item [\textsf{.unc}] ---  ('none') How uncertainty is calculated ('none', 'guf', 'mcm').
        \item [\textsf{.cor.req}] ---  (0) Correlation matrix is required for all input quantities.
        \item [\textsf{.cor.gen}] ---  (1) Zero correlation matrix is generated automatically if missing.
        \item [\textsf{.dof.req}] ---  (0) Degrees of freedom are required for all input quantities.
        \item [\textsf{.dof.gen}] ---  (1) Degree of freedom are generated automatically if missing with value 50.
        \item [\textsf{.mcm.repeats}] ---  (100) Number of Monte Carlo iterations.
        \item [\textsf{.mcm.verbose}] ---  (1) Display various informations concerning Monte Carlo method.
        \item [\textsf{.mcm.method}] ---  ('singlecore') Parallelization method ('multicore', 'multistation').
        \item [\textsf{.mcm.procno}] ---  (0) Number of processors to use.
        \item [\textsf{.mcm.tmpdir}] ---  ('.') Directory for temporary data.
        \item [\textsf{.mcm.randomize}] ---  (1) Randomized uncertainties are generated automatically if missing.
\end{tightdesc}

\subsection{\textsf{.strict}} %<<<3 ------------------------------
\label{structcalcsetstrict}
Boolean, default value 0. If set to zero, all other fields of the structure are generated
automatically and set to a default value.

\subsection{\textsf{.verbose}} %<<<3 ------------------------------
\label{structcalcsetverbose}
Boolean, default value 1. If set to non-zero value, various messages are displayed during
calculation, such as used uncertainty calculation method, automatic generation of matrices etc.

\subsection{\textsf{.checkinputs}} %<<<3 ------------------------------
\label{structcalcsetverbose}
Boolean, default value 1. If set to zero, all checks of inputs (calculation settings, input data)
are skipped. However if inputs are not proper, various undocumented errors can happen. This option
can be used to speed up qwtb processing. About 2~ms of processing data can be saved (iCore 5, GNU
Octave 4.2.2). User have to be sure all inputs conform proper format and contain all needed data.

\subsection{\textsf{.unc}} %<<<3 ------------------------------
\label{structcalcsetunc}
String, default value 'none'. Determines uncertainty calculation method. Only three values are possible:
\begin{tightdesc}
        \item [\textsf{'none'}] ---  Uncertainty is not calculated.
        \item [\textsf{'guf'}] ---  Uncertainty is calculated by GUM Uncertainty Framework~\cite{JCGM1995}.
        \item [\textsf{'mcm'}] ---  Uncertainty is calculated by Monte Carlo Method~\cite{JCGM2008}.
\end{tightdesc}
See chapter XXX %XXX
for uncertainty calculation details.

\subsection{\textsf{.cor}} %<<<3 ------------------------------
\label{structcalcsetcor}
Structure sets handling of correlation matrices of quantities. Structure has two fields:
\begin{tightdesc}
        \item [\textsf{.req}] ---  Boolean, default value 0. If non-zero, correlation matrices are required for all quantities.
        \item [\textsf{.gen}] ---  Boolean, default value 1. If non-zero, correlation matrices will be generated
        automatically if missing in quantity.
\end{tightdesc}
Automatically generated correlation matrices has all elements of zero value.

\subsection{\textsf{.dof}} %<<<3 ------------------------------
\label{structcalcsetdof}
Structure sets handling of degrees of freedom of quantities. Structure has two fields:
\begin{tightdesc}
        \item [\textsf{.req}] ---  Boolean, default value 0. If non-zero, degrees of freedom are required for all quantities.
        \item [\textsf{.gen}] ---  Boolean, default value 1. If non-zero, degree of freedom will be generated
        automatically if missing in quantity.
\end{tightdesc}
Automatically generated degree of freedom has value 50.

\subsection{\textsf{.mcm}} %<<<3 ------------------------------
\label{structcalcsetmcm}
Structure sets handling of Monte Carlo calculation of uncertainties. Structure has following fields:
\begin{tightdesc}
        \item [\textsf{.repeats}] ---  Positive non-zero integer, default value 100. Number of iterations of Monte Carlo method.

        \item [\textsf{.verbose}] ---  Boolean, default value 1. If set to non-zero value, various messages
        are displayed during calculation of Monte Carlo method such as used parallelization method,
        number of calculated iterations etc.

        \item [\textsf{.method}] ---  String, default value 'singlecore'. Parallelization method used for Monte
        Carlo method calculation. Only three values are possible:
        \begin{tightdesc}
                \item [\textsf{'singlecore'}] ---  No parallelization, all is calculated on one CPU core.
                \item [\textsf{'multicore'}] ---  Calculation is divided into cores of one computer.
                \item [\textsf{'multistation'}] ---  Calculation is distributed on several computers.
        \end{tightdesc}
        Not all methods are possible to use on all computers. 'singlecore' is always possible to
        use. 'multicore' use parfor in Matlab or parcellfun in GNU Octave. 'multistation' use %XXX

        \item [\textsf{.procno}] ---  Zero or positive integer, default value 0. Number of CPU cores exploitable
        by the parallelization method \textsf{'multicore'}. If set to zero, all available CPU cores will be used. If
        desktop computer is used, it is good practice to set to number of CPU cores minus one, so
        the computer can be used by other task also. 
        Works only in \octave.

        \item [\textsf{.tmpdir}] ---  String, default value '.' (current directory). Temporary directory for
        storing temporary data needed for some parallelization methods. %XXX which ones?

        \item [\textsf{.randomize}] ---  Boolean, default value 1. If non-zero, randomized uncertainties will be
        generated automatically if missing, but only if uncertainty calculation method is set to
        'mcm' (Monte Carlo) to prevent large memory usage.
\end{tightdesc}

%\section{qwtb.m subfunctions list} %<<<2 ----------------------------------------
%Short list and descriptions of subfunctions in {\tt qwtb.m} file:
% XXX 2DO

\section{qwtb.m flow chart} %<<<2 ----------------------------------------
Following figure shows flow chart inside of {\tt qwtb.m} file with subfunctions.
\begin{center}
        \includegraphics[width=1.2\textwidth, angle=90]{sources/inner_flowchart.pdf}
\end{center}

\newpage
Following figure shows dependencies of the {\tt qwtb.m} file.
\begin{center}
        \includegraphics[width=1.4\textwidth, angle=90]{sources/dependencies.pdf}
\end{center}


\section{How uncertainty calculation works} %<<<2 ----------------------------------------
%2DO


\section{How to add a new algorithm} %<<<2 ----------------------------------------
%2DO
To add a new algorithm, several steps have to be done.

\begin{enumerate}
        \item Select an algorithm ID. Usually it is an acronym or abbreviation of the new algorithm name.

        \item Create a directory named {\tt alg\_SOMEID}, where {\tt SOMEID} is a selected ID. For a
        directory structure, see~\ref{diralg}.

        \item Put all files required by the algorithm (i.e. scripts, libraries) into the directory
        {\tt alg\_SOMEID/}.

        \item Create a file {\tt alg\_SOMEID/alg\_info.m}. An example of such file follows.
        \begin{lstlisting} %<<<3
        function info = alg_info() 
        % Part of QWTB. Info script for algorithm SOMEALG.
        %
        % See also qwtb

        info.id = 'SOMEID';
        info.name = 'SOMEALG';
        info.desc = 'SOMEID is an super mega hyper algorithm for calculation of the ultimate answer to everything.';
        info.citation = 'Some nifty paper in some super journal.';
        info.remarks = 'Very simple implementation';
        info.license = 'MIT License';
        info.inputs(1).name = 'a';
        info.inputs(1).desc = 'Some important input';
        info.inputs(1).alternative = 0;
        info.inputs(1).optional = 0;
        info.inputs(1).parameter = 0;
        info.inputs(2).name = 'b';
        info.inputs(2).desc = 'Some other input ';
        info.inputs(2).alternative = 0;
        info.inputs(2).optional = 0;
        info.inputs(2).parameter = 0;
        info.outputs(1).name = 'x';
        info.outputs(1).desc = 'Some output';
        info.outputs(2).name = 'y';
        info.outputs(2).desc = 'Other output';
        info.providesGUF = 1;
        info.providesMCM = 0;
        \end{lstlisting} %>>>3

        \item Create a wrapper for the algorithm in a file {\tt alg\_SOMEID/alg\_wrapper.m}, see~\ref{filealgwrapper}. An example of simple wrapper
        file follows.
        \begin{lstlisting} %<<<3
        function dataout = alg_wrapper(datain, calcset)
        % Part of QWTB. Wrapper script for algorithm SOMEALG.
        %
        % See also qwtb

        % Format input data
        % SOMEALG definition is:
        % function [x, y, z] = SOMEALG(a, b);
        a = datain.a.v;
        b = datain.b.v;

        % Call algorithm
        [x, y, z] = SOMEALG(a, b);

        % Format output data:
        dataout.x.v = x;
        dataout.y.v = y;
        dataout.z.v = z;

        end % function
        \end{lstlisting} %>>>3

        \item Put a license of the algorithm into the file {\tt alg\_SOMEID/LICENSE.txt}.

        \item Create a testing script {\tt alg\_SOMEID/alg\_test.m}. This is optional, however
        recomended. An example follows.
        \begin{lstlisting} %<<<3
        function alg_test(calcset)
        % Part of QWTB. Test script for algorithm SOMEALG
        %
        % See also qwtb

        % Generate sample data 
        DI = [];
        U = 1; V = 2;
        DI.a.v = [U:V];
        DI.b.v = U/V;

        % Call algorithm
        DO = qwtb('SOMEID', DI);

        % Check results 
        assert((DO.x.v > U.*(1-1e6)) & (DO.x.v < U.*(1+1e6)));
        assert((DO.y.v > V.*(1-1e6)) & (DO.y.v < V.*(1+1e6)));
        assert((DO.z.v > sqrt(U).*(1-1e6)) & (DO.z.v < sqrt(U).*(1+1e6)));

        end % function
        \end{lstlisting}

        \item Create an example script {\tt alg\_SOMEID/alg\_example.m}. This is optional, however
        recomended. An example follows.
        \begin{lstlisting}
        %% SOMEALGNAME
        % Example for algorithm SOMEID.
        %
        % SOMEID is an super mega hyper algorithm for calculation of the ultimate answer to
        % everything.
        %

        %% Generate sample data
        % Two quantities are prepared: |a| and |b|, representing something and something even more
        % important.
        DI = [];
        U = 1; V = 2;
        DI.a.v = [U:V];
        DI.b.v = U/V;

        %% Call algorithm
        % Use QWTB to apply algorithm |SOMEID| to data |DI|.
        CS.verbose = 1;
        DO = qwtb('SOMEID', DI, CS);

        %% Display results
        % Results is the very answer.
        x = DO.x.v
        y = DO.y.v
        z = DO.z.v
        %%
        % Errors of estimation in parts per milion:
        xerrppm = (DO.x.v - U)/U .* 1e6
        yerrppm = (DO.y.v - V)/V .* 1e6
        zerrppm = (DO.z.v - sqrt(U)/sqrt(U) .* 1e6
        \end{lstlisting} %>>>3

        \item Check and test everything. Send your contribution to qwtb authors. Ask them to
        generate a new documentation. Celebrate.

\end{enumerate}

\chapter{Licensing} %<<<1 ----------------------------------------
\label{ch-license}
Every algorithm has its own license. License of every algorithm is placed in the directory of the
algorithm in a file named {\tt LICENSE.txt}. Type of the license is included in the algorithm information structure, see
chapter \ref{structalginfo}. The license of an algorithm can be displayed by following syntax:
\begin{lstlisting}
license = qwtb('algid', 'license')
\end{lstlisting}

The license of the toolbox itself is MIT License, please see file {\tt LICENSE.txt} in the directory
containing script {\tt qwtb.m}.

\chapter{QWTBLVLib \& simple QWTB GUI} %<<<1 ----------------------------------------
\section{QWTBLVLib} %<<<2 ----------------------------------------
QWTBLVLib is a set of \labview Virtual Instruments (VI) forming a library and providing an easy link
between \labview and QWTB. It uses {\em MATLAB Script
Node} to make {\em ActiveX} calls to \matlab and run QWTB. In future a use of {\sc GOLPI} is intended to run QWTB
by means of \octave.

Description of particular VIs and example of use is a part of the library.
Following figure shows the content of {\tt VI Tree.vi}.

\begin{center}
        \includegraphics[width=\textwidth]{sources/QWTBLVLib-vitree.png}
\end{center}

\section{simple QWTB GUI} %<<<2 ----------------------------------------
simple QWTB GUI (Graphical User Interface) is a fully working example of using QWTBLVLib written in \labview.
User can browse available algorithms and its descriptions, load or simulate data, run calculations
with selected algorithm and view results.

See following figure with a screen shot of the Simple QWTB GUI.

\begin{center}
        \includegraphics[width=\textwidth]{sources/simpleQWTBGUI.png}
\end{center}

After a start of simple QWTB GUI a window with several buttons is shown. To show
a window with a list of input quantities, to set input quantities or to generate input quantities
press button {\tt Show Input Quantities}. To list of available algorithms and algorithm informations
or to select algorithm press button
{\tt Show Algorithms}. To set calculation settings or GUI settings pres  button {\tt Show Settings}.
To run calculation with set input quantities and selected algorithm press  button {\tt Calculate!}.
To view output quantities press button {\tt Show Output Quantities}. To quit the simple QWTB
GUI press button {\tt QUIT}.

The work flow is following. After the start user have to set the directory containing QWTB in window
{\tt Settings}. Next user have to set input quantities in window {\tt Input Quantities}. After selecting required
algorithm in window {\tt Algorithms} the user can pres button {\tt Calculate!}. The results can be
reviewed in window {\tt Output quantities}.


% Bibliography %<<<1 ------------------------------
%%\bibliographystyle{ieeetr}
\printbibliography[title={Bilbiography},heading={bibnumbered}]

\appendix \chapter{Quick reference} %<<<1 ------------------------------
\newpage
{\small \textbf{Toolbox use:}\\[-1.5em]
\begin{lstlisting}[basicstyle=\small]
                         [alginfo] = qwtb()
                           dataout = qwtb('algid', datain)
[dataout, datain, calcset] = qwtb('algid', datain)
                           dataout = qwtb('algid', datain, calcset)
[dataout, datain, calcset] = qwtb('algid', datain, calcset)
                                           qwtb('algid', 'example')
                                           qwtb('algid', 'test')
                            alginfo = qwtb('algid', 'info')
                                           qwtb('algid', 'addpath')
                                           qwtb('algid', 'rempath')
                            license = qwtb('algid', 'license')
\end{lstlisting}

\vskip-1.5em
\noindent \textbf{Algorithm informations structure (\ref{structalginfo}):}\\[-1.5em]
\begin{description}[itemsep=-0.5em]
        \item [\textsf{.id}] --- Designator of the algorithm (\ref{structalginfoid})
        \item [\textsf{.name}] ---  Name of the algorithm (\ref{structalginfoname}).
        \item [\textsf{.desc}] ---  Basic description (\ref{structalginfodesc}).
        \item [\textsf{.citation}] ---  Reference (\ref{structalginfocitation}).
        \item [\textsf{.remarks}] ---  Any remark (\ref{structalginforemarks}).
        \item [\textsf{.license}] ---  License of the algorithm (\ref{structalginfolicense}).
        \item [\textsf{.inputs}] ---  Input quantities definitions (\ref{structalginfoinputs}).
        \item [\textsf{.outputs}] ---  Output quantities definitions (\ref{structalginfooutputs}).
        \item [\textsf{.providesGUF}] ---  Algorithm/wrapper calculates GUF uncertainty (\ref{structalginfoprovidesGUF}).
        \item [\textsf{.providesMCM}] ---  Algorithm/wrapper calculates MCM uncertainty (\ref{structalginfoprovidesMCM}).
        \item [\textsf{.fullpath}] ---  Full path to the algorithm. Automatically generated by the
        toolbox (\ref{structalginfofullpath}).
\end{description}
\textbf{Quantity structure (\ref{structquantity}):}\\[-1.5em]
\begin{description}[itemsep=-0.5em]
        \item [\textsf{.v}] --- Value (\ref{structquantityv}).
        \item [\textsf{.u}] --- Uncertainty (\ref{structquantityu}).
        \item [\textsf{.d}] --- Degree of freedom (\ref{structquantityd}).
        \item [\textsf{.c}] --- Correlation (\ref{structquantityc}).
        \item [\textsf{.r}] --- Randomized uncertainty (\ref{structquantityr}).
\end{description}
\textbf{Calculation settings structure (\ref{structcalcset}):}\\[-1.5em]
\begin{description}[itemsep=-0.5em]
        \item [\textsf{.strict}] ---  (0) If zero, other fields generated automatically
        (\ref{structcalcsetstrict}).
        \item [\textsf{.verbose}] ---  (1) Display various informations (\ref{structcalcsetverbose}).
        \item [\textsf{.unc}] ---  ('none') How uncertainty is calculated ('none', 'guf', 'mcm')
        (\ref{structcalcsetunc}).
        \item [\textsf{.cor.req}] ---  (0) Correlation matrix is required for all input quantities
        (\ref{structcalcsetcor}).
        \item [\textsf{.cor.gen}] ---  (1) Zero correlation matrix is generated automatically if
        missing (\ref{structcalcsetcor}).
        \item [\textsf{.dof.req}] ---  (0) Degrees of freedom are required for all input quantities
        (\ref{structcalcsetdof}).
        \item [\textsf{.dof.gen}] ---  (1) Degree of freedom are generated automat. if missing
        with value 50 (\ref{structcalcsetdof}).
        \item [\textsf{.mcm.repeats}] ---  (100) Number of Monte Carlo iterations
        (\ref{structcalcsetmcm}).
        \item [\textsf{.mcm.verbose}] ---  (1) Display various informations concerning Monte Carlo
        method (\ref{structcalcsetmcm}).
        \item [\textsf{.mcm.method}] ---  ('singlecore') Parallelization method ('multicore',
        'multistation') (\ref{structcalcsetmcm}).
        \item [\textsf{.mcm.procno}] ---  (0) Number of processors to use (\ref{structcalcsetmcm}).
        \item [\textsf{.mcm.tmpdir}] ---  ('.') Directory for temporary data
        (\ref{structcalcsetmcm}).
        \item [\textsf{.mcm.randomize}] ---  (1) Randomized uncert. are generated
        automat. if missing (\ref{structcalcsetmcm}).
\end{description}
}

\chapter{Simple example of QWTB use} %<<<1 ----------------------------------
\input{qwtb_examples_published/qwtb_example_1.tex}

\chapter{Long example of QWTB use} %<<<1 ----------------------------------
\input{qwtb_examples_published/qwtb_example_2.tex}

\end{document}

% vim settings: vim:foldmarker=%<<<,%>>> fdm=marker fen
